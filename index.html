<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글쓰기 기록지</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Jua', cursive;
            background-color: #fffde7;
            color: #4a4a4a;
        }

        .font-jua {
            font-family: 'Jua', cursive;
        }

        .font-nanum {
            font-family: 'Nanum Pen Script', cursive;
        }

        .pastel-yellow {
            background-color: #fff9c4;
        }

        .pastel-green {
            background-color: #e6ffb2;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #6a1b9a;
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
        }

        .penname-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .viewing-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
    </style>
</head>
<body class="p-4">

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <p class="animate-pulse">로딩 중... 🚀</p>
    </div>

    <!-- 필명 설정 모달 -->
    <div id="pennameModal" class="penname-modal hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg text-center max-w-sm w-full">
            <h2 class="text-2xl font-jua mb-4">필명 설정하기 🎨</h2>
            <p class="text-gray-600 mb-4 font-nanum">활동하고 싶은 필명을 입력해주세요!</p>
            <input type="text" id="pennameInput" class="w-full p-3 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400 font-nanum" placeholder="예: 글쟁이 루비">
            <button id="setPennameBtn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                시작하기 🎉
            </button>
        </div>
    </div>

    <!-- 다른 친구 기록 보기 모달 -->
    <div id="viewingModal" class="viewing-modal hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-lg w-full">
            <h2 id="viewingPenname" class="text-2xl font-jua mb-2 text-yellow-600"></h2>
            <p id="viewingDate" class="text-sm text-gray-500 mb-4"></p>
            
            <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-300">
                <h3 class="text-lg font-bold text-yellow-700 mb-1">주요 내용 📝</h3>
                <p id="viewingMainContent" class="font-nanum text-gray-800 whitespace-pre-wrap"></p>
            </div>

            <div class="bg-green-50 p-4 rounded-lg mb-4 border border-green-300">
                <h3 class="text-lg font-bold text-green-700 mb-1">다음에 작성할 내용 💡</h3>
                <p id="viewingNextContent" class="font-nanum text-gray-800 whitespace-pre-wrap"></p>
            </div>

            <button id="closeViewingModal" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                닫기
            </button>
        </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- 필명 표시 -->
        <div class="text-right text-sm text-gray-500 font-nanum">
            현재 필명: <span id="pennameDisplay" class="font-bold"></span>
        </div>

        <!-- 고정 섹션: 작품 정보 -->
        <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-lg border-2 border-yellow-300">
            <h1 class="text-3xl font-bold text-center text-yellow-600 mb-2 font-jua">
                글쓰기 기록지 ✍️
            </h1>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm font-nanum">
                <div class="p-2 rounded-lg bg-pastel-yellow border border-yellow-400">
                    <label class="block text-yellow-700 font-bold mb-1">작품 제목</label>
                    <textarea id="projectTitle" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
                <div class="p-2 rounded-lg bg-pastel-green border border-green-400">
                    <label class="block text-green-700 font-bold mb-1">시놉시스</label>
                    <textarea id="synopsis" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
                <div class="p-2 rounded-lg bg-pastel-yellow border border-yellow-400">
                    <label class="block text-yellow-700 font-bold mb-1">인물</label>
                    <textarea id="characters" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
                <div class="p-2 rounded-lg bg-pastel-green border border-green-400">
                    <label class="block text-green-700 font-bold mb-1">복선</label>
                    <textarea id="foreshadowing" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
            </div>
        </div>

        <!-- 월간 달력 -->
        <div class="p-4 bg-white rounded-xl shadow-lg border-2 border-green-300">
            <div class="flex justify-between items-center mb-4">
                <button id="prevMonthBtn" class="bg-yellow-300 hover:bg-yellow-400 text-yellow-800 p-2 rounded-full shadow-md transition transform hover:scale-105">
                    <span class="font-bold text-xl">◀️</span>
                </button>
                <h2 id="currentMonth" class="text-2xl font-bold text-center text-green-700"></h2>
                <button id="nextMonthBtn" class="bg-yellow-300 hover:bg-yellow-400 text-yellow-800 p-2 rounded-full shadow-md transition transform hover:scale-105">
                    <span class="font-bold text-xl">▶️</span>
                </button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center">
                <div class="font-bold text-red-500">일</div>
                <div class="font-bold">월</div>
                <div class="font-bold">화</div>
                <div class="font-bold">수</div>
                <div class="font-bold">목</div>
                <div class="font-bold">금</div>
                <div class="font-bold text-blue-500">토</div>
            </div>
        </div>

        <!-- 글쓰기 내용 입력 및 수정/삭제 폼 -->
        <div id="writingForm" class="p-4 bg-white rounded-xl shadow-lg border-2 border-yellow-300 hidden">
            <h3 id="formDate" class="text-2xl font-bold text-center text-yellow-600 mb-4"></h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-lg font-bold text-yellow-700 mb-1">주요 내용 📝</label>
                    <textarea id="mainContent" class="w-full p-3 rounded-lg bg-yellow-50 border border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-y" rows="5"></textarea>
                </div>
                <div>
                    <label class="block text-lg font-bold text-green-700 mb-1">다음에 작성할 내용 💡</label>
                    <textarea id="nextContent" class="w-full p-3 rounded-lg bg-green-50 border border-green-300 focus:outline-none focus:ring-2 focus:ring-green-400 resize-y" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button id="saveBtn" class="bg-green-400 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                        저장하기 ✨
                    </button>
                    <button id="deleteBtn" class="bg-red-400 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                        삭제하기 🗑️
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Firebase 전역 변수 설정
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // Firebase 초기화
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // Firestore 경로 설정
        let penName = null;
        let userId = null;
        let privateProjectInfoDocRef = null;
        let publicWritingEntriesColRef = null;

        // UI 요소
        const loadingOverlay = document.getElementById('loadingOverlay');
        const showLoading = () => { loadingOverlay.classList.remove('hidden'); };
        const hideLoading = () => { loadingOverlay.classList.add('hidden'); };

        const pennameModal = document.getElementById('pennameModal');
        const pennameInput = document.getElementById('pennameInput');
        const setPennameBtn = document.getElementById('setPennameBtn');
        const pennameDisplay = document.getElementById('pennameDisplay');

        const viewingModal = document.getElementById('viewingModal');
        const closeViewingModalBtn = document.getElementById('closeViewingModal');
        const viewingPennameEl = document.getElementById('viewingPenname');
        const viewingDateEl = document.getElementById('viewingDate');
        const viewingMainContentEl = document.getElementById('viewingMainContent');
        const viewingNextContentEl = document.getElementById('viewingNextContent');
        
        const currentMonthEl = document.getElementById('currentMonth');
        const calendarGrid = document.getElementById('calendarGrid');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const writingForm = document.getElementById('writingForm');
        const formDateEl = document.getElementById('formDate');
        const mainContentEl = document.getElementById('mainContent');
        const nextContentEl = document.getElementById('nextContent');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        const projectTitleEl = document.getElementById('projectTitle');
        const synopsisEl = document.getElementById('synopsis');
        const charactersEl = document.getElementById('characters');
        const foreshadowingEl = document.getElementById('foreshadowing');

        let currentDate = new Date();
        let selectedDate = null;
        let writingData = {};
        
        // 달력 생성 함수
        const renderCalendar = () => {
            if (!penName) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthName = new Intl.DateTimeFormat('ko-KR', {
                year: 'numeric',
                month: 'long'
            }).format(currentDate);
            currentMonthEl.textContent = monthName;

            const oldDays = calendarGrid.querySelectorAll('.day');
            oldDays.forEach(day => day.remove());

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDiv = document.createElement('div');
                calendarGrid.appendChild(emptyDiv);
            }

            for (let day = 1; day <= lastDayOfMonth; day++) {
                const dayDiv = document.createElement('div');
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayDiv.textContent = day;
                dayDiv.classList.add('day', 'p-2', 'rounded-full', 'cursor-pointer', 'transition', 'transform', 'hover:scale-110', 'hover:shadow-md');
                dayDiv.dataset.date = dateString;

                if (writingData[dateString] && writingData[dateString].penName) {
                    const entryPenName = writingData[dateString].penName;
                    if (entryPenName === penName) {
                        // 내 기록
                        dayDiv.classList.add('bg-green-400', 'text-white', 'font-bold', 'border-2', 'border-green-600');
                        dayDiv.textContent = `${day} ✅`;
                        dayDiv.title = `나의 기록: ${writingData[dateString].mainContent}`;
                    } else {
                        // 다른 친구 기록
                        dayDiv.classList.add('bg-blue-400', 'text-white', 'font-bold', 'border-2', 'border-blue-600');
                        dayDiv.textContent = `${day} 🤝`;
                        dayDiv.title = `친구의 기록 (${entryPenName}): ${writingData[dateString].mainContent}`;
                    }
                } else {
                    dayDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
                }

                if (selectedDate && selectedDate.toDateString() === new Date(year, month, day).toDateString()) {
                    dayDiv.classList.add('ring-4', 'ring-blue-400');
                }
                
                dayDiv.addEventListener('click', () => {
                    handleDayClick(new Date(year, month, day));
                });
                calendarGrid.appendChild(dayDiv);
            }
        };

        const handleDayClick = (date) => {
            showLoading();
            setTimeout(() => {
                selectedDate = date;
                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                const entry = writingData[dateString];
                
                if (entry && entry.penName === penName) {
                    // 내 기록이 있으면 수정/삭제 폼 표시
                    formDateEl.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
                    mainContentEl.value = entry.mainContent;
                    nextContentEl.value = entry.nextContent;
                    writingForm.classList.remove('hidden');
                    viewingModal.classList.add('hidden');
                } else if (entry && entry.penName !== penName) {
                    // 다른 친구 기록이 있으면 보기 전용 모달 표시
                    viewingPennameEl.textContent = entry.penName;
                    viewingDateEl.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
                    viewingMainContentEl.textContent = entry.mainContent;
                    viewingNextContentEl.textContent = entry.nextContent;
                    viewingModal.classList.remove('hidden');
                    writingForm.classList.add('hidden');
                } else {
                    // 기록이 없으면 새 글쓰기 폼 표시
                    formDateEl.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
                    mainContentEl.value = '';
                    nextContentEl.value = '';
                    writingForm.classList.remove('hidden');
                    viewingModal.classList.add('hidden');
                }

                renderCalendar();
                hideLoading();
            }, 300);
        };

        const setupFirestoreListeners = () => {
            if (!penName || !userId) {
                console.error("필명 또는 사용자 ID가 설정되지 않아 Firestore 리스너를 설정할 수 없습니다.");
                return;
            }

            // privateProjectInfoDocRef를 userId 기반으로 설정
            privateProjectInfoDocRef = db.collection(`artifacts/${appId}/users/${userId}/project_data`).doc('project_info');
            // publicWritingEntriesColRef는 penName 기반으로 설정
            publicWritingEntriesColRef = db.collection(`artifacts/${appId}/public/data/writing_entries`);

            // 공용 캘린더 데이터를 실시간으로 수신
            publicWritingEntriesColRef.onSnapshot((snapshot) => {
                writingData = {};
                snapshot.forEach((doc) => {
                    writingData[doc.id] = doc.data();
                });
                renderCalendar();
            }, (error) => {
                console.error("글쓰기 기록 리스너 오류:", error);
            });

            // 개인 작품 정보를 실시간으로 수신
            privateProjectInfoDocRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    projectTitleEl.value = data.title || '';
                    synopsisEl.value = data.synopsis || '';
                    charactersEl.value = data.characters || '';
                    foreshadowingEl.value = data.foreshadowing || '';
                }
            }, (error) => {
                console.error("작품 정보 리스너 오류:", error);
            });
        };

        const saveProjectInfo = async () => {
            if (!userId) {
                console.error("작품 정보 저장 실패: 사용자 ID 없음");
                return;
            }
            try {
                await privateProjectInfoDocRef.set({
                    title: projectTitleEl.value,
                    synopsis: synopsisEl.value,
                    characters: charactersEl.value,
                    foreshadowing: foreshadowingEl.value
                });
            } catch (error) {
                console.error("작품 정보 저장 실패:", error);
            }
        };

        const saveWritingEntry = async () => {
            if (!selectedDate || !penName) return;
            showLoading();
            const dateString = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            const data = {
                penName: penName,
                mainContent: mainContentEl.value,
                nextContent: nextContentEl.value
            };
            try {
                await publicWritingEntriesColRef.doc(dateString).set(data);
                writingForm.classList.add('hidden');
            } catch (error) {
                console.error("저장 실패:", error);
            }
            hideLoading();
        };

        const deleteWritingEntry = async () => {
            if (!selectedDate || !penName) return;
            showLoading();
            const dateString = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            try {
                if (writingData[dateString] && writingData[dateString].penName === penName) {
                    await publicWritingEntriesColRef.doc(dateString).delete();
                } else {
                    console.error("삭제 실패: 본인이 작성한 기록이 아니거나, 데이터가 없습니다.");
                }
                writingForm.classList.add('hidden');
                mainContentEl.value = '';
                nextContentEl.value = '';
            } catch (error) {
                console.error("삭제 실패:", error);
            }
            hideLoading();
        };

        // 초기 인증 상태 확인
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                
                const pennameDocRef = db.collection(`artifacts/${appId}/public/data/user_profiles`).doc(userId);
                pennameDocRef.onSnapshot((docSnap) => {
                    if (docSnap.exists && docSnap.data().penName) {
                        penName = docSnap.data().penName;
                        pennameDisplay.textContent = penName;
                        setupFirestoreListeners();
                        pennameModal.classList.add('hidden');
                        hideLoading();
                    } else {
                        pennameModal.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("필명 로드 오류:", error);
                    pennameModal.classList.remove('hidden');
                });
            } else {
                console.log("사용자 인증 대기 중.");
                pennameModal.classList.remove('hidden');
            }
        });

        // 초기 인증 시도
        showLoading();
        if (initialAuthToken) {
            auth.signInWithCustomToken(initialAuthToken).catch(error => {
                console.error("커스텀 토큰 인증 실패:", error);
                auth.signInAnonymously();
            });
        } else {
            auth.signInAnonymously();
        }

        // 필명 설정 이벤트
        setPennameBtn.addEventListener('click', async () => {
            const newPenName = pennameInput.value.trim();
            if (newPenName) {
                showLoading();
                const pennameDocRef = db.collection(`artifacts/${appId}/public/data/user_profiles`).doc(userId);
                await pennameDocRef.set({ penName: newPenName });
                penName = newPenName;
                pennameDisplay.textContent = penName;
                setupFirestoreListeners();
                pennameModal.classList.add('hidden');
                hideLoading();
            }
        });

        // 이벤트 리스너 설정
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        closeViewingModalBtn.addEventListener('click', () => {
            viewingModal.classList.add('hidden');
        });

        saveBtn.addEventListener('click', saveWritingEntry);
        deleteBtn.addEventListener('click', deleteWritingEntry);
        
        [projectTitleEl, synopsisEl, charactersEl, foreshadowingEl].forEach(el => {
            el.addEventListener('input', saveProjectInfo);
        });
    </script>
</body>
</html>
