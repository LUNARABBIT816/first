<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ì“°ê¸° ê¸°ë¡ì§€</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Jua', cursive;
            background-color: #fffde7;
            color: #4a4a4a;
        }

        .font-jua {
            font-family: 'Jua', cursive;
        }

        .font-nanum {
            font-family: 'Nanum Pen Script', cursive;
        }

        .pastel-yellow {
            background-color: #fff9c4;
        }

        .pastel-green {
            background-color: #e6ffb2;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #6a1b9a;
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
        }

        .penname-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .viewing-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
    </style>
</head>
<body class="p-4">

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <p class="animate-pulse">ë¡œë”© ì¤‘... ğŸš€</p>
    </div>

    <!-- í•„ëª… ì„¤ì • ëª¨ë‹¬ -->
    <div id="pennameModal" class="penname-modal hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg text-center max-w-sm w-full">
            <h2 class="text-2xl font-jua mb-4">í•„ëª… ì„¤ì •í•˜ê¸° ğŸ¨</h2>
            <p class="text-gray-600 mb-4 font-nanum">í™œë™í•˜ê³  ì‹¶ì€ í•„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!</p>
            <input type="text" id="pennameInput" class="w-full p-3 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400 font-nanum" placeholder="ì˜ˆ: ê¸€ìŸì´ ë£¨ë¹„">
            <button id="setPennameBtn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                ì‹œì‘í•˜ê¸° ğŸ‰
            </button>
        </div>
    </div>

    <!-- ë‹¤ë¥¸ ì¹œêµ¬ ê¸°ë¡ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="viewingModal" class="viewing-modal hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-lg w-full">
            <h2 id="viewingPenname" class="text-2xl font-jua mb-2 text-yellow-600"></h2>
            <p id="viewingDate" class="text-sm text-gray-500 mb-4"></p>
            
            <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-300">
                <h3 class="text-lg font-bold text-yellow-700 mb-1">ì£¼ìš” ë‚´ìš© ğŸ“</h3>
                <p id="viewingMainContent" class="font-nanum text-gray-800 whitespace-pre-wrap"></p>
            </div>

            <div class="bg-green-50 p-4 rounded-lg mb-4 border border-green-300">
                <h3 class="text-lg font-bold text-green-700 mb-1">ë‹¤ìŒì— ì‘ì„±í•  ë‚´ìš© ğŸ’¡</h3>
                <p id="viewingNextContent" class="font-nanum text-gray-800 whitespace-pre-wrap"></p>
            </div>

            <button id="closeViewingModal" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                ë‹«ê¸°
            </button>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- í•„ëª… í‘œì‹œ -->
        <div class="text-right text-sm text-gray-500 font-nanum">
            í˜„ì¬ í•„ëª…: <span id="pennameDisplay" class="font-bold"></span>
        </div>

        <!-- ê³ ì • ì„¹ì…˜: ì‘í’ˆ ì •ë³´ -->
        <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-lg border-2 border-yellow-300">
            <h1 class="text-3xl font-bold text-center text-yellow-600 mb-2 font-jua">
                ê¸€ì“°ê¸° ê¸°ë¡ì§€ âœï¸
            </h1>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm font-nanum">
                <div class="p-2 rounded-lg bg-pastel-yellow border border-yellow-400">
                    <label class="block text-yellow-700 font-bold mb-1">ì‘í’ˆ ì œëª©</label>
                    <textarea id="projectTitle" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
                <div class="p-2 rounded-lg bg-pastel-green border border-green-400">
                    <label class="block text-green-700 font-bold mb-1">ì‹œë†‰ì‹œìŠ¤</label>
                    <textarea id="synopsis" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
                <div class="p-2 rounded-lg bg-pastel-yellow border border-yellow-400">
                    <label class="block text-yellow-700 font-bold mb-1">ì¸ë¬¼</label>
                    <textarea id="characters" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
                <div class="p-2 rounded-lg bg-pastel-green border border-green-400">
                    <label class="block text-green-700 font-bold mb-1">ë³µì„ </label>
                    <textarea id="foreshadowing" class="w-full bg-transparent resize-none focus:outline-none" rows="1"></textarea>
                </div>
            </div>
        </div>

        <!-- ì›”ê°„ ë‹¬ë ¥ -->
        <div class="p-4 bg-white rounded-xl shadow-lg border-2 border-green-300">
            <div class="flex justify-between items-center mb-4">
                <button id="prevMonthBtn" class="bg-yellow-300 hover:bg-yellow-400 text-yellow-800 p-2 rounded-full shadow-md transition transform hover:scale-105">
                    <span class="font-bold text-xl">â—€ï¸</span>
                </button>
                <h2 id="currentMonth" class="text-2xl font-bold text-center text-green-700"></h2>
                <button id="nextMonthBtn" class="bg-yellow-300 hover:bg-yellow-400 text-yellow-800 p-2 rounded-full shadow-md transition transform hover:scale-105">
                    <span class="font-bold text-xl">â–¶ï¸</span>
                </button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center">
                <div class="font-bold text-red-500">ì¼</div>
                <div class="font-bold">ì›”</div>
                <div class="font-bold">í™”</div>
                <div class="font-bold">ìˆ˜</div>
                <div class="font-bold">ëª©</div>
                <div class="font-bold">ê¸ˆ</div>
                <div class="font-bold text-blue-500">í† </div>
            </div>
        </div>

        <!-- ê¸€ì“°ê¸° ë‚´ìš© ì…ë ¥ ë° ìˆ˜ì •/ì‚­ì œ í¼ -->
        <div id="writingForm" class="p-4 bg-white rounded-xl shadow-lg border-2 border-yellow-300 hidden">
            <h3 id="formDate" class="text-2xl font-bold text-center text-yellow-600 mb-4"></h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-lg font-bold text-yellow-700 mb-1">ì£¼ìš” ë‚´ìš© ğŸ“</label>
                    <textarea id="mainContent" class="w-full p-3 rounded-lg bg-yellow-50 border border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-y" rows="5"></textarea>
                </div>
                <div>
                    <label class="block text-lg font-bold text-green-700 mb-1">ë‹¤ìŒì— ì‘ì„±í•  ë‚´ìš© ğŸ’¡</label>
                    <textarea id="nextContent" class="w-full p-3 rounded-lg bg-green-50 border border-green-300 focus:outline-none focus:ring-2 focus:ring-green-400 resize-y" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button id="saveBtn" class="bg-green-400 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                        ì €ì¥í•˜ê¸° âœ¨
                    </button>
                    <button id="deleteBtn" class="bg-red-400 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition transform hover:scale-105">
                        ì‚­ì œí•˜ê¸° ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Firebase ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // Firebase ì´ˆê¸°í™”
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // Firestore ê²½ë¡œ ì„¤ì •
        let penName = null;
        let userId = null;
        let privateProjectInfoDocRef = null;
        let publicWritingEntriesColRef = null;

        // UI ìš”ì†Œ
        const loadingOverlay = document.getElementById('loadingOverlay');
        const showLoading = () => { loadingOverlay.classList.remove('hidden'); };
        const hideLoading = () => { loadingOverlay.classList.add('hidden'); };

        const pennameModal = document.getElementById('pennameModal');
        const pennameInput = document.getElementById('pennameInput');
        const setPennameBtn = document.getElementById('setPennameBtn');
        const pennameDisplay = document.getElementById('pennameDisplay');

        const viewingModal = document.getElementById('viewingModal');
        const closeViewingModalBtn = document.getElementById('closeViewingModal');
        const viewingPennameEl = document.getElementById('viewingPenname');
        const viewingDateEl = document.getElementById('viewingDate');
        const viewingMainContentEl = document.getElementById('viewingMainContent');
        const viewingNextContentEl = document.getElementById('viewingNextContent');
        
        const currentMonthEl = document.getElementById('currentMonth');
        const calendarGrid = document.getElementById('calendarGrid');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const writingForm = document.getElementById('writingForm');
        const formDateEl = document.getElementById('formDate');
        const mainContentEl = document.getElementById('mainContent');
        const nextContentEl = document.getElementById('nextContent');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        const projectTitleEl = document.getElementById('projectTitle');
        const synopsisEl = document.getElementById('synopsis');
        const charactersEl = document.getElementById('characters');
        const foreshadowingEl = document.getElementById('foreshadowing');

        let currentDate = new Date();
        let selectedDate = null;
        let writingData = {};
        
        // ë‹¬ë ¥ ìƒì„± í•¨ìˆ˜
        const renderCalendar = () => {
            if (!penName) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthName = new Intl.DateTimeFormat('ko-KR', {
                year: 'numeric',
                month: 'long'
            }).format(currentDate);
            currentMonthEl.textContent = monthName;

            const oldDays = calendarGrid.querySelectorAll('.day');
            oldDays.forEach(day => day.remove());

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDiv = document.createElement('div');
                calendarGrid.appendChild(emptyDiv);
            }

            for (let day = 1; day <= lastDayOfMonth; day++) {
                const dayDiv = document.createElement('div');
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayDiv.textContent = day;
                dayDiv.classList.add('day', 'p-2', 'rounded-full', 'cursor-pointer', 'transition', 'transform', 'hover:scale-110', 'hover:shadow-md');
                dayDiv.dataset.date = dateString;

                if (writingData[dateString] && writingData[dateString].penName) {
                    const entryPenName = writingData[dateString].penName;
                    if (entryPenName === penName) {
                        // ë‚´ ê¸°ë¡
                        dayDiv.classList.add('bg-green-400', 'text-white', 'font-bold', 'border-2', 'border-green-600');
                        dayDiv.textContent = `${day} âœ…`;
                        dayDiv.title = `ë‚˜ì˜ ê¸°ë¡: ${writingData[dateString].mainContent}`;
                    } else {
                        // ë‹¤ë¥¸ ì¹œêµ¬ ê¸°ë¡
                        dayDiv.classList.add('bg-blue-400', 'text-white', 'font-bold', 'border-2', 'border-blue-600');
                        dayDiv.textContent = `${day} ğŸ¤`;
                        dayDiv.title = `ì¹œêµ¬ì˜ ê¸°ë¡ (${entryPenName}): ${writingData[dateString].mainContent}`;
                    }
                } else {
                    dayDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
                }

                if (selectedDate && selectedDate.toDateString() === new Date(year, month, day).toDateString()) {
                    dayDiv.classList.add('ring-4', 'ring-blue-400');
                }
                
                dayDiv.addEventListener('click', () => {
                    handleDayClick(new Date(year, month, day));
                });
                calendarGrid.appendChild(dayDiv);
            }
        };

        const handleDayClick = (date) => {
            showLoading();
            setTimeout(() => {
                selectedDate = date;
                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                const entry = writingData[dateString];
                
                if (entry && entry.penName === penName) {
                    // ë‚´ ê¸°ë¡ì´ ìˆìœ¼ë©´ ìˆ˜ì •/ì‚­ì œ í¼ í‘œì‹œ
                    formDateEl.textContent = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
                    mainContentEl.value = entry.mainContent;
                    nextContentEl.value = entry.nextContent;
                    writingForm.classList.remove('hidden');
                    viewingModal.classList.add('hidden');
                } else if (entry && entry.penName !== penName) {
                    // ë‹¤ë¥¸ ì¹œêµ¬ ê¸°ë¡ì´ ìˆìœ¼ë©´ ë³´ê¸° ì „ìš© ëª¨ë‹¬ í‘œì‹œ
                    viewingPennameEl.textContent = entry.penName;
                    viewingDateEl.textContent = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
                    viewingMainContentEl.textContent = entry.mainContent;
                    viewingNextContentEl.textContent = entry.nextContent;
                    viewingModal.classList.remove('hidden');
                    writingForm.classList.add('hidden');
                } else {
                    // ê¸°ë¡ì´ ì—†ìœ¼ë©´ ìƒˆ ê¸€ì“°ê¸° í¼ í‘œì‹œ
                    formDateEl.textContent = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
                    mainContentEl.value = '';
                    nextContentEl.value = '';
                    writingForm.classList.remove('hidden');
                    viewingModal.classList.add('hidden');
                }

                renderCalendar();
                hideLoading();
            }, 300);
        };

        const setupFirestoreListeners = () => {
            if (!penName || !userId) {
                console.error("í•„ëª… ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ Firestore ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // privateProjectInfoDocRefë¥¼ userId ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
            privateProjectInfoDocRef = db.collection(`artifacts/${appId}/users/${userId}/project_data`).doc('project_info');
            // publicWritingEntriesColRefëŠ” penName ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
            publicWritingEntriesColRef = db.collection(`artifacts/${appId}/public/data/writing_entries`);

            // ê³µìš© ìº˜ë¦°ë” ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ 
            publicWritingEntriesColRef.onSnapshot((snapshot) => {
                writingData = {};
                snapshot.forEach((doc) => {
                    writingData[doc.id] = doc.data();
                });
                renderCalendar();
            }, (error) => {
                console.error("ê¸€ì“°ê¸° ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            });

            // ê°œì¸ ì‘í’ˆ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ 
            privateProjectInfoDocRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    projectTitleEl.value = data.title || '';
                    synopsisEl.value = data.synopsis || '';
                    charactersEl.value = data.characters || '';
                    foreshadowingEl.value = data.foreshadowing || '';
                }
            }, (error) => {
                console.error("ì‘í’ˆ ì •ë³´ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            });
        };

        const saveProjectInfo = async () => {
            if (!userId) {
                console.error("ì‘í’ˆ ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ì‚¬ìš©ì ID ì—†ìŒ");
                return;
            }
            try {
                await privateProjectInfoDocRef.set({
                    title: projectTitleEl.value,
                    synopsis: synopsisEl.value,
                    characters: charactersEl.value,
                    foreshadowing: foreshadowingEl.value
                });
            } catch (error) {
                console.error("ì‘í’ˆ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:", error);
            }
        };

        const saveWritingEntry = async () => {
            if (!selectedDate || !penName) return;
            showLoading();
            const dateString = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            const data = {
                penName: penName,
                mainContent: mainContentEl.value,
                nextContent: nextContentEl.value
            };
            try {
                await publicWritingEntriesColRef.doc(dateString).set(data);
                writingForm.classList.add('hidden');
            } catch (error) {
                console.error("ì €ì¥ ì‹¤íŒ¨:", error);
            }
            hideLoading();
        };

        const deleteWritingEntry = async () => {
            if (!selectedDate || !penName) return;
            showLoading();
            const dateString = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            try {
                if (writingData[dateString] && writingData[dateString].penName === penName) {
                    await publicWritingEntriesColRef.doc(dateString).delete();
                } else {
                    console.error("ì‚­ì œ ì‹¤íŒ¨: ë³¸ì¸ì´ ì‘ì„±í•œ ê¸°ë¡ì´ ì•„ë‹ˆê±°ë‚˜, ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
                writingForm.classList.add('hidden');
                mainContentEl.value = '';
                nextContentEl.value = '';
            } catch (error) {
                console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
            }
            hideLoading();
        };

        // ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                
                const pennameDocRef = db.collection(`artifacts/${appId}/public/data/user_profiles`).doc(userId);
                pennameDocRef.onSnapshot((docSnap) => {
                    if (docSnap.exists && docSnap.data().penName) {
                        penName = docSnap.data().penName;
                        pennameDisplay.textContent = penName;
                        setupFirestoreListeners();
                        pennameModal.classList.add('hidden');
                        hideLoading();
                    } else {
                        pennameModal.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("í•„ëª… ë¡œë“œ ì˜¤ë¥˜:", error);
                    pennameModal.classList.remove('hidden');
                });
            } else {
                console.log("ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘.");
                pennameModal.classList.remove('hidden');
            }
        });

        // ì´ˆê¸° ì¸ì¦ ì‹œë„
        showLoading();
        if (initialAuthToken) {
            auth.signInWithCustomToken(initialAuthToken).catch(error => {
                console.error("ì»¤ìŠ¤í…€ í† í° ì¸ì¦ ì‹¤íŒ¨:", error);
                auth.signInAnonymously();
            });
        } else {
            auth.signInAnonymously();
        }

        // í•„ëª… ì„¤ì • ì´ë²¤íŠ¸
        setPennameBtn.addEventListener('click', async () => {
            const newPenName = pennameInput.value.trim();
            if (newPenName) {
                showLoading();
                const pennameDocRef = db.collection(`artifacts/${appId}/public/data/user_profiles`).doc(userId);
                await pennameDocRef.set({ penName: newPenName });
                penName = newPenName;
                pennameDisplay.textContent = penName;
                setupFirestoreListeners();
                pennameModal.classList.add('hidden');
                hideLoading();
            }
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        closeViewingModalBtn.addEventListener('click', () => {
            viewingModal.classList.add('hidden');
        });

        saveBtn.addEventListener('click', saveWritingEntry);
        deleteBtn.addEventListener('click', deleteWritingEntry);
        
        [projectTitleEl, synopsisEl, charactersEl, foreshadowingEl].forEach(el => {
            el.addEventListener('input', saveProjectInfo);
        });
    </script>
</body>
</html>
